原始演讲地址：https://gdcvault.com/play/1034600/Open-World-Rendering-Techniques-in[1]
演讲名：Open World Rendering Techniques in 'Hogwarts Legacy'
演讲者：Rob Hall
公司名：Avalanche Software介绍游戏开发了五年多的时间，并且从自研引擎迁移到了虚幻引擎。使用虚幻引擎4.27 Chaos版本发布了游戏，并在超过22个平台和变体上展示了它，包括不同的FPS模式、光线追踪技术，这也是Avalanche Software首次制作开放世界RPG。在本次演讲中，首先，要处理开放世界的复杂性问题，接着利用少量资源来降低这种复杂性，具体来说，深入解释光影和布料的优化。还会花一点时间讨论如何利用自动化技术来优化GPU性能。最后，将展示在开发过程中创造的所有独特视觉技术。开放世界复杂性首先，将从开放世界的复杂性开始谈起。在游戏中有一个如展示在地图上的开放世界，其面积有九平方公里。在这里有霍格沃茨城堡、霍格莫德。游戏中所有的门都能打开。单就开放的世界部分而言，有73个可玩区块和107个不可玩区块。接着，在这些不同的地点上标记了58个地下城、40个废墟、47个流窜营地、11个小村庄和113个金库。所以可以看出游戏可能会有多么复杂。霍格莫德有40栋独立的建筑，并且属于开放世界的一部分。霍格沃茨城堡则拥有200个房间。那么如何管理这种复杂性呢？首先，将会流式卸载所有不可见的内容，剔除一切、对一切进行细节层次处理、一切都必须能够缩放，并且实例化一切。在开放世界中，与一切相关的事情真的很多。关于流式加载，这是GPU性能的第一道防线，只加载相关的内容。飞行扫帚对流式加载提出了额外的挑战。同时，还需要将加载屏幕降至最少出现。这里有三张图片，左边的是你的游戏相机视角，中间是带有流式加载的放大相机视角，第三张则是放大后没有使用流式加载的视角。可以看到，对于最后两张图片来说，通过流式加载实际上需要渲染的内容要少得多。剔除一切。所有不透明物体都可以通过一个通用的Dithered Alpha方法来渲染，这样可以避免当物体被剔除时产生难看的闪现。这就让细小的物体和NPC慢慢淡出视野。此外，还实施了室内外剔除，根据不同类别和光源的投射阴影特性来剔除光源。还会避免在远离镜头的地方生成粒子效果。关于加载，所有的网格级LOD必须在每个模型上存在。接着将不同层级的LOD烘焙成HLOD，并且流式处理单独的层级替换为烘焙的代理层级。通过渐变交叉淡化来实现的，以防止画面突变。这里展示了霍格沃茨城堡的实际比较和它的烘焙代理。所有东西都必须可扩展。任何图形特性如果只能在空房间里运行，那就没有用。所以希望大多数图形特性能够一直运行，并且每项功能都需要有一个开关，它不会造成明显的可视化的影响。这里，展示了从高端到低端平台的对比。其中存在一些差异，但可以看到整个游戏完整无缺且仍在运行。在UE4中渲染线程是一个巨大的瓶颈。被限制在每帧大约10,000次绘制调用，以及大约同样数量的对象进行可见性测试。正因为此，尽可能地实例化一切。为了这个，无绑定资源是一个关键特性。引擎改造应对开放世界的复杂性需要对UE4引擎进行改动。在整个渲染管线中加入了无绑定图形技术。采用了基于Compute Shader的分块延迟光照渲染，烘焙光探针体积，结合体积光照和体积雾渲染。半透明的水和体积材质支持不透明渲染管线中的同一些主要特性，例如阴影。所有这些都需要对引擎进行改变。无绑定资源首先从高层次的概述来谈谈无绑定资源。这是硬件GPU上一个完全支持的特性，在过去10年的图形硬件上都得到了支持。关键的特性之一是可以实例化纹理。如果从低级别来讲，这就是一个在着色器中可以进行索引的资源数组。优点。首先，它为整个渲染管线解锁了新的优化机会。这包括不需要纹理图集，每个纹理可以是不同的大小。这也是批处理3D纹理的唯一方法。还可以在着色器中动态读取纹理，并可使用非一致纹理读。可以实例化那些共享同一着色但拥有不同纹理的对象。单次光注入可以用于体积光和雾效。“非一致纹理读取”（divergent texture read），在执行并行指令时所有的线程尝试访问不同的纹理位置，在一些架构上这可能导致性能下降，因为并行的线程依赖于统一的执行路径来最大化性能。缺点。不支持无绑定的GPU没有容易的回退方案。我们使用的UE4.27 Chaos不支持这一点，因此不得不花费大量努力将这一技术集成到引擎中。所以每次版本升级都需要调整，新平台同样如此。而且，非一致纹理读在某些硬件上可能代价高昂。尽管如此，在一个绘制调用或指令中还是只能访问大约2000个资源。这是使用无绑定列表的地方。因为它们很多，这里只讨论其中一些。比如材质实例化、体积光照和雾效渲染、光探针、反射捕捉、材质中的通用数组、阴影、多层布料、远程视图代理、贴花和光照贴图等。分块延迟渲染技术。有几个无绑定的特性使用了这个技术，比如阴影、光源、反射捕获和光探针。这个技术包括将屏幕划分为16x16像素的块，并为每个块分配其引用的所有阴影、光源、反射和探针的总数。2D分块用于不透明对象，以及3D体素用于透明对象。根据每个块使用的特性进行分类。例如，对于光照，根据头发、皮肤次表面散射进行分类；对于定向阴影，分类则基于透射、重叠的级联阴影以及与相机的距离。针对每种分类类型进行一次间接的Compute派发。材质实例化。现在任何共享同一着色器的材质都可以被实例化。在一个图书馆场景中非常明显，不知道有多少本书，但你可以实例化它们，这是一个很大的提升。当然，像岩石这样的物体也进行了实例化。体积光照和正向渲染。我们希望支持和延迟渲染相同数量的功能。因此，阴影、反射捕捉器和探针在正向渲染中都得到了完全支持。正向着色很昂贵，因此还是倾向于使用延迟渲染。所有材质都与环境相匹配。这里有一个测试图片，有四个不透明的球体，对比体积光照材质和镜面球体，可以看到它们彼此非常匹配。体积光照进行了一些增强，只需要将光照数据渲染到屏幕空间的Voxels中。这个数据可以被重用于体积光照和透明材质。它通常由于代价而被限制在一个小距离范围内，但我们做了性能改进以将这个距离扩展到500米。为了实现这一点，划分了几个质量层级，这是基于Z距离和层级深度的。从相机到70米处，它是全光照质量，到了500米，只用了定向光，并且渲染了四分之一的样本进行时间累积采样。最后一级没有体积雾，只有指数型高度雾。无绑定的光探针。因为霍格沃茨的大部分地方并不是按网格对齐的，所以我们更倾向于使用探针。在各处放置了光探针，而无绑定是在着色器中访问多个探针体积的唯一方式。这里不打算详细讨论光探针，因为那足以单独成为一个单独的演讲。但是，这里展示光探针在视觉上为游戏带来了什么变化。左边的是使用了光探头的效果，右边是没有使用光探头的对比。这里可以看到光探针体积，这是格兰芬多塔楼，可以看到在那里使用了多少不同的探针体积来融合环境。因此既使用了立方体也使用了圆柱体探针体积。在霍格沃茨，有很多圆形塔楼，所以增加了圆柱体探针体积。由于有非常多的探针体积，还需要在GPU上进行遮挡剔除，并且只会流入一部分探针体积。阴影探针。在所有地方都增加了间接阴影。基本上，这是沿着探针中的主导光源方向进行的接触阴影追踪。我们使用了一个公式来做主导光遮蔽。这里有一张使用阴影探针的标准图片。接下来，谈谈无绑定的反射捕获。利用无绑定技术避免了合并所有反射捕获的反射图集。这使能够支持大量的反射捕获器。霍格沃茨城堡有超过500个这样的反射捕获器，但通常每帧只显示大约50个。对于前向渲染的材质，也支持和延迟渲染相同数量的反射。对于水面，遇到了一个独特的情况。因为视差校正的反射贴图与水不太搭配，它们会导致右侧图中所展示的接缝问题。因此，在这些情况下，对水面使用了非视差校正的立方体映射。这其实就是将摄像机最近的反射捕获器赋值给水面，并根据摄像机位置在不同的反射捕获器之间交叉淡入淡出。材质中的通用数组，对于艺术家使用参数化数组是一大进步。这里有一个来自虚幻引擎的例子。这是为了支持这项功能而添加的所有独特内容，它允许使用这种方法代替诸如流控制来采样纹理，纹理图集，纹理数组等。可以通过一个索引简单地选择数组中的纹理，这非常方便。远距离植被代理，这用于渲染非常远处的树木。这是在视域代理之后的额外步骤，通过进行批处理步骤将所有远距离的视域实例化在一起，这一步进一步帮助减少了绘制调用。如果仔细观察右边的图片，可以看到远处有许多小树。无绑定阴影接下里深入讲解一下无绑定阴影技术。在之前提到了分块延迟照明技术，它能够高效地处理大量的光照问题。那么问题是，如何能够渲染成百上千个产生阴影的灯光呢？这就是无绑定阴影技术的用武之地。无绑定阴影技术能在相同的渲染路径中访问大量的阴影图。对于不透明材质，使用了Compute阴影，并有独立的计算路径。每种灯光类型都有一个计算分派。这些数据被打包进一个SRV（着色器资源视图）中，然后在计算光照路径中被查询。这也意味着所有的阴影图在体积和前向渲染通道都可用。例如，在游戏的某些部分，我们观察到在单个帧中使用了超过250张阴影图。具体来说，对于点光源和聚光灯的阴影，为每个灯光渲染完全动态的阴影是不可行的。因此，我们利用了一系列特征来根据距离摄像机的远近进行调整。即便这样，仍然有超过200张阴影图，特别是在这个视角下。最主要的重点是确保大多数阴影都是缓存的。可以看到这里的灯光锥，这是调试视图，以及在霍格莫德夜晚可用的阴影数量。我们为每盏灯设计了一个特征矩阵，可以独立地打开和关闭这些特征。对于缓存阴影图，这是阴影中的绝大多数。根据屏幕大小计算分辨率，所有这些都是根据分辨率分配的。所以即使有大量的灯光，距离越远，分辨率就会越低。对于可移动阴影图，每帧只渲染最近的可移动物体。这也可以显式地在不重要的灯光上关闭。而在电影过场时，还有一个提升模式，用于4K阴影图。因此，可以看到眼镜的阴影。此外还输出了1/32分辨率的UAV，用来跳过读取可移动阴影图。对于接触阴影，它在电影过场时增加了额外的细节，在远处也是如此。还有一种选项，不用渲染完整的阴影图也可以获得一定的阴影效果。胶囊阴影被用作近似的蒙皮几何体，当没有可移动阴影启用时，它适用于所有那些不重要的灯光。这是通过数学计算实现的，还通过胶囊体积裁剪减少了每像素的复杂性。这与虚幻引擎4现存的胶囊阴影相比有所增强。LUMOS阴影在游戏中是非常有特点的。LUMOS咒语是用来在魔杖上产生一个光源。这需要动态立方体贴图阴影，它是相当昂贵的。高端平台可以很好地处理这个问题，但低端平台如何应对呢？我们使用了可伸缩性来解决这个问题。首先，只有当玩家角色使用LUMOS时，阴影才会激活，任何其他NPC都不会这样。还利用顶点着色器中的SV_RenderTargetArrayIndex，这样一来，单通道点光就不需要使用几何着色器进行渲染了。还跳过了阴影图渲染尝试缓存，因为它始终在移动。需要注意的是，这个LUMOS阴影的最重要部分是玩家角色，以及其他在移动的角色。因此，在低端平台上，仅渲染可移动物体来维持可动阴影的错觉。接下来是定向光阴影，这是游戏中带有大量复杂性的最大开销之一，我们将其限制为只有一个定向光。这里有质量设置，紧邻摄像机的是动态阴影渐变区，大约到45米。接下来，我们有500米以内的缓存定向阴影，然后到最远位置的接触阴影，它们在远处表现得非常好。动态级联阴影标准级联阴影。可以有多达三个渐变区，它是完全动态的，并随着一天中的时间移动。然后是接触阴影。这通过不渲染诸如草和石头之类的小物体节省了大量性能。还可以在没有阴影图的远处添加阴影。接下来是独特的缓存定向阴影。这对游戏来说是独一无二的。随着你远离摄像机，渲染阴影变得越来越昂贵。不容易在有移动光源的情况下运行缓存定向阴影，这就是游戏中所面临的挑战。所以我们使用了基于区块的缓存系统。这是基于Turchyn的工作，通过绑定阴影图，这非常快速易计算，并且从最快平台到任天堂Switch都能很好地扩展。首先将摄像机视锥点投影到光空间。下一步，围绕这些点创建光空间的凸包。将这分割成128米乘以128米的区块对齐到光空间网格。此时，每一片区块都可以重复使用，但仍然限制每帧只渲染一个区块。在阴影投射方面，首先根据距离摄像机的远近对这些区块进行预排序。然后运行一个Compute Job，将每个屏幕空间区块和任何碰撞的阴影区块关联起来。之后运行Compute Job以计算每像素的阴影。这里独特的部分是只选择第一个范围内的阴影图并且跳过其余的。在之前提到的基于分块的延迟分类（tile deferred classification），这里展示一下具体是什么样子。这里有排列组合设置，这非常有助于减少动态分支和着色器中的性能消耗。这是一个显示在使用中的分块的全屏可视化器。可以看到因为植被，有很多次表面反射和其它效果。所以对于阴影投射效能来说，这可以分开计算，变得很经济，并且使用可伸缩设置来弥补不同平台间的差异。下面的数据包括渲染整个定向光阴影蒙版的时间，包括动态级联、投射阴影和接触阴影。在PS5上，这占用了半毫秒。如之前提到的，每帧只缓存一个分块。通常，没有额外努力是不够的。首先只渲染最近的未缓存的分块，并且在摄像机裁剪后会有大量分块请求剧增，因此在摄像机裁剪后每帧渲染两个分块，直到缓存被填满，并且竭尽所能避免清空这个缓存。有很多情况或条件会使缓存失效，包括移动物体、时间变化、物体的流入和流出、以及LOD转换。接下来将逐一讨论这些情况。首先，移动物体。直接跳过在缓存中渲染这些移动物体。对于在风中摇摆的植被，它们仍然会被渲染到缓存中，但是会忽略失效检查。由于有45米动态级联距离紧挨着你，所以这不会很明显。日夜循环。正如之前提到的，游戏的全日周期是48分钟，光源方向不断变化，这阻碍了缓存。因此，只捕获用于阴影的光源方向。这使我们有12秒的时间窗口来缓存区块。过了这个时间窗口，开始为新的光源方向缓存区块。大约需要50帧来填满缓存。当摄像机旋转时需要更长时间，因为优先处理现有的阴影缓存更新。一旦缓存填满，就会用新的光源方向交叉淡入阴影。交叉淡入的效果很微妙，但这足以在日夜变换时做到让人信服。谈流入和流出的物体。对于每一个流入的物体，检查它是否与现有缓存中的区块范围相交，并且为该区块增加一个“脏”值。然后，只在现有的缓存已满并且没有交叉淡入活动（也就是没有额外工作）时渲染区块。根据时间阈值和“脏”值阈值来对它们进行优先级排序。由于在远处往往不太注意到，不进行任何单独的区块交叉淡入处理。对于LOD变化而导致的问题，也就是主摄像机的阴影图LOD与主摄像头不匹配时，会出现自我遮挡伪影。在这种情况下，通常会看到岩石中间出现一处瑕疵。不幸的是，LODs总是在交换，所以不可能一直无效化缓存。只有在LOD差异很大时才能察觉到，因此解决方案是存储区块缓存时的摄像机位置，并且只有当摄像机位置与缓存位置之间的距离非常大时才使区块失效。日出和日落时的特殊情况，此时由于成角角度，阴影的渲染成本明显增加，有时会是顶部的四倍。注意到我们总是在山谷底部进行游戏，在日出和日落时山脉总是在阴影中。因此，在这些时间段简单地关闭了方向光。要指出的是，方向光仍然会在大气和天空中被渲染，因为这些仍然可见。尽管在这段时间没有直接的阴影，但是光探针提供了大量的环境阴影，可以在下方看到角色的阴影。布料材质接下来深入探讨无绑定布料技术的内容。首先，介绍多层材质。角色艺术家使用能通过权重图进行混合的最多包含16层布料层的材料，这是一个计算成本相当高的操作。因此，核心问题就是如何使用无绑定技术来提高效率。布料材质结合了宏观和微观细节，宏观细节包括像布料褶皱这样的布料特定细节。微观细节采用多层区域来处理，比如布缝合线和纺织品的花纹。这样可以在极端放大时保持细节的清晰度。每一层只包含三个纹理，并遵循物理基础渲染(PBR)的原则。通过这些技术，可以展现出各种不同材质，如布料、皮革、丝绸、毛皮和金属等。接下来引入所说的无绑定布料。首先，通过每像素读取纹理以确定哪些层需要混合，然后假设只需要混合1到2层。这意味着所有层都必须使用相同的代码路径，而由于大多数布料层不会有太多重叠，所以大多数像素只需要混合一层。为了实现这一点，需要进行一些烘焙操作。这里提到了最多16张混合蒙版纹理，这些纹理需要烘焙到两张纹理中：区域ID纹理和混合纹理。烘焙操作对于每个像素，从所有蒙版纹理中获取两个最大值，每个值为相邻像素的最大值。如果只有一个值，则在区域ID纹理中写出蒙版索引，并为单个纹理写出权重。如果有两个值，则将两个蒙版索引打包成一个8位值写入区域ID纹理。然后是如何处理这些无绑定布料区域，虽然有16个可用层，但每个像素只采样两层。并在HLSL中，使用了特殊的关键词来启用非一致性资源索引，这对于在UE中实现非一致性纹理读取很关键。结果是区域ID和混合纹理两个纹理，区域ID由于是打包的位掩码，因此不可进行压缩。线性过滤，不能过滤区域ID纹理。但如果准确地操作，混合纹理则可以过滤。为了解决这个问题，将区域ID沿着相邻像素扩散来覆盖双线性过滤的范围。MipMap也是无法工作的，无法使用标准的平均方法来处理区域ID纹理。处理方法是下采样所有的混合遮罩纹理，再通过新的混合遮罩纹理生成新的区域ID纹理，然后再次扩展这些像素。当采样这些布料区域时，有16个可用层，但每个像素仅采样其中的两层。示例代码显示了此过程的实现。需要注意的是，这涉及到了图形硬件上可能较慢的非一致性纹理读取。在HLSL中，使用的关键字是“non uniform resource index”，它允许非一致性性纹理读取。在UE引擎中，这通过材质图中的泛化数组特性来处理。此外，还对层的信息进行了泛化。对于UV，将它们烘焙到2x2的旋转缩放矩阵和偏移量中。依靠PBR概念，材质可以表现出所有类型的布料，使用的纹理包括了基础色彩、法线以及金属度、粗糙度和绒毛。总体上看，此技术的引入极大地节约了性能，不再需要在材料中采样16层。如果考虑未打包的版本，每层材料需要四个纹理（包括PBR纹理），乘以16层，相当于64次纹理采样。使用打包版本，最坏情况下有两层材料的三个PBR纹理，再加上ID纹理和权重纹理，一共8次纹理采样。这个方法还允许在游戏中共享微观细节图，各种布料材质可以无成本地添加小细节。也可以针对每个家庭创作独特的材质且无需为每个家庭提供独特的材质。当然，这种方法也有一些缺点，例如，非一致性纹理读取在某些图形硬件上可能较慢，低MIP等级的图像在区域边缘可能会出现渗色问题。同时，如果区域之间的三角或者四边形顶点只和每像素两层混合的话，效果也不会很好。总的来说，尽管有其劣势，性能的提升和节省使我们必须围绕这些问题进行工作。自动优化GPU性能在优化GPU性能时，投入了大量时间使用自动化技术。因为尽管进行了许多优化，但游戏内容和代码方面仍然需要更多的优化，这是一个非常大的游戏。所以使用自动化测试来帮助达到性能预算。这个系统每天运行多次，它跟踪CPU和GPU的性能指标。全世界有超过300个测试，这里不能分享太多细节，因为这些都在另一场演讲中。所以这里只分享结果。这确保了优化能覆盖整个游戏，即使是那些奇怪的区域，那些没人注意的地方。任何性能退化都会迅速得到修复。所有团队也都在努力降低数字。每个人都被分配了一个区域，并且负责监督它。这里的结果是，对于PS4，有大约两年的优化数据。开始时只有25%的测试在预算内。经过那段时间，95%的测试都在预算内。举一个极端的例子，有一个测试从每帧68毫秒优化到了26毫秒，将这种优化应用到所有平台，取得了非常好的结果。VFX是另一个有趣的发展领域，因为你如何解决VFX峰值问题呢？所以自动化揭示了这些问题，原本有50毫秒的峰值的地方，通过这些信息和额外的测试等等，能够将它们减少到3毫秒以下。这里展示的是渲染半透明物体的GPU时间图表。将这些数据与视频自动化相关联，艺术家们利用这些信息进行优化。自动化在平台之间的调整中也非常重要。这使能够调整不同平台之间的可伸缩性设置。这里再次展示了平台。通常会选择性能较低的平台，因为它们非常容易发现性能问题，然后将这些优化重新应用，大多数优化也可以应用到所有平台。这也是一个很大的好处。视效技术好的，现在来展示一下游戏的部分内容，这部分内容会少一些技术细节。这些特性包括：昼夜变换、季节变换、材质变化、天气系统、实时绘画和云层效果。昼夜变换之前提到过，游戏中的一天时间周期是48分钟，限定了太阳轨迹固定在一年中的某一天。这是因为需要为烘焙光照探针做出调整，为了得到良好的日间效果，必须确保一切都安排得当。这包括调整灯光、雾气、云层、天空和自发光材质。基于物理的光照值。使用这些值来平衡灯光，这里是范围：太阳是100,000 lux，非常亮。需要预曝光的颜色来处理这么亮的阳光。好处是，由于它们是基于物理的，HDR效果非常好，只需对引擎做一些修改。添加一个ACES参数化圆锥曲线。简单来说，这是一个单阶段色调映射，将你的ACES亮度值适应到你的显示设备上。这能够更好地适应个人使用的不同显示设备。我们不得不使用HGIG显示查询来获取正确的亮度值，并且还为艺术家提供了HDR可视化工具，以帮助他们获得正确的动态范围。不幸的是，当有极亮的阳光时，如果有任何光线泄漏到室内，就会非常明显。这里有一个体积光和雾的例子，它很容易泄漏，因为是以低分辨率屏幕空间渲染的。所以需要做很多事情来修复或减少这个问题。其中一个例子是，使用内部体积来阻挡光线。对于曝光，根据一天中的时间，用曲线驱动了8个后期处理参数。有5个与一天中时间相关的照明曲线，以及3个与太阳高度相关的曲线。我们使用了曝光补偿曲线，而且没有使用曝光测量遮罩。在户外，曝光最小最大值被设置为-14到16。还使用了自适应光照和自发光材质的适配，这是为了确保在不同情况下，灯光和材质不会太亮或太暗。这里展示的四种方法：基于自动曝光、基于场景平均亮度（这是最常见的）、基于一天中时间调整的，接下来将讨论每一种。首先是自动曝光。这很简单，它只是取当前摄像机的曝光值。例如，使用它让Lumos在任何地方看起来都很亮。不幸的是，当你从户外移动到室内时，这个方法会失效。Lumos的亮度可能会因此翻倍或者翻三倍，所以很难做到恰到好处。因此在Lumos上添加了一个特殊的闪烁效果来重置自动曝光。对于VFX，希望它们无论白天还是晚上都看起来很亮。典型VFX使用固定亮度，这会在白天看起来偏暗，在夜晚看起来过亮。我们不想要这样。所以使用了自动曝光来确保一切都会亮，并且正确地产生亮度和泛光效果。前提到的最常见的是场景平均亮度，但这在相机切换后的第一帧就会崩溃。所以有几个选项可以用一个指定值来覆盖，或者坚持使用上一帧的值。这并不总是能保证工作。特别是Lumos，在有相机切换、大曝光变化或其他条件时，会闪烁成黑色。这里的解决方案是所谓的光探针适应。我们使用光探针数据进行适应，这些探针数据在同一帧渲染时就可用。这意味着在相机切换时不会有突然出现的问题。因此，过场电影制作团队非常喜欢这个，尽可能地使用它。另一个例子是幽灵，他们也依赖于光探针适应来匹配他们的亮度和环境。为了生成这个光探针适应，所做的就是在摄像机周围大约一米处采样光探针。这些探针的采样方式与前向渲染材质完全相同，将这些结果保存到一个缓冲区中，然后你的材质照明通道可以读取这个缓冲区来进行适应。这是在开发的后期添加的，所以本可以建立一个更健壮的系统，只要有更多时间。最后，基于一天中时间调整的灯光。这个方法你只需要在CPU上采样天空大气着色器，使用相同的数学公式，然后根据一天中的时间调整亮度和颜色。这里有一个例子，在禁林中，我们有三个不同时间的同样的灯光，我们想要不管树上面有多亮，都能保持那种不祥的感觉。接下来，基于一天中时间调整的自发光材质，在CPU上更新参数，这很常见。为窗户和灯笼做了这样的处理。然后天空，通常天空在黎明和黄昏时会完全变黑。为了在这里添加一些细节，在天空大气着色器中添加了一个HDR地平线到天顶的纹理，用来模拟夜间散射。这里有一个例子，左边是使用的纹理，使用负高度和太阳度数从-12到90。V是天空穹顶的Z值。对于夜空，月亮是基于真实的NASA数据，有准确的月相和照明。还渲染了四颗可见的行星，以及最亮的41000颗星星的准确位置。这也是根据1890年代的时间和位置准确定位的。所以任何有企图心的天文学家也许可以从中得出一些东西，你可能会对结果感到惊讶。我们还有一张手绘的银河系。星星的数量根据平台进行缩放，它们还通过一个自定义的Niagara数据接口，使用UE粒子系统渲染。还有一个天文迷你游戏，使用精确的夜空来突出星座和个别星星。这里是那个迷你游戏的快照。季节变换接下来，看看季节变换。这里是同一个摄像机拍摄的四个不同季节的场景。可以看到它们的差异，或者说它们看起来有多不同。夏天、秋天、冬天和春天。对于季节变化，添加了特定于季节的计算。所以，给每种材质添加特定于季节的计算会相当耗费资源，尤其是如果每个季节都有独特的资源的话。需要注意的是，并不是所有东西都需要根据季节变化，通常只有树叶、草和地形纹理需要变化。使用了基于季节的资源交换，只根据当前季节来加载资源。当改变季节时，希望季节变化时有一个视觉上引人注目的变化。所以把这个任务交给了故事情节。没有一个无缝混合的系统来处理这个。还使用了预渲染的视频来实现这种过渡。对于基于地区的季节，沿海地区没有降雪，所以只在这里展示的山区渲染雪。对于基于地区的季节，某些任务发生在高山上。所以那里固定是冬天。很酷的是，艺术家们不需要做任何额外的工作，因为一切都已经为季节变化做好了准备。材质变换器材质变换器，它可以实时进行材质交换。通过在材质图中切换特定的静态开关参数来构建变换后的材质。下面是其中一个例子，通过切换这些开关来构建这些变换后的材质。这个技术被用于天气变化、魔法效果和实时绘画等。游戏中有52种这样的效果，超过1400种变换后的材质。可以用这些变换后的材质做很多事情，比如覆盖材质，包括半透明和双面效果。还有材质参数的变换，仅此一项，任何材质都可以被覆盖。还允许为那些变换器不太适用的地方手工制作材质。这里有一些例子来展示它，死亡嚎叫效果。它是一个为视觉特效艺术家构建的基于蓝图的材质参数动画系统。天气天气系统，这个是基于一天中的时间来控制的。还有雨滴纹理或者天气纹理。在同一个纹理的alpha通道中处理了天气积累的效果。对于天气效果，我们不想把它烘焙到材质中，所以使用了天气贴花。对于那些看起来不太好的部分，使用材质交换，这样就可以处理像移动物体和半透明材质这样的情况。还在贴花上使用了模板遮罩，这样如果材质被交换了，就可以避免渲染到贴花的通道上，其他物体也可以使用相同的模板来禁止天气效果。对于移动物体，使用材质变换器，每个移动物体都存储一个天气状态，以显示积累或衰减。这也是很消耗资源的，所以在选择如何更新这些时要小心。天气遮罩，处理不应该在室内出现天气。如果使用动态的自上而下的天气过程，渲染过程会太消耗资源。因此，通过多种方式进行遮罩，有一个虚拟纹理来捕捉自上而下的视图。还使用了法线和内部体积，对于半透明粒子，将距离场和内部体积烘焙到距离场中，也来遮罩它们。雪，贴花在像树叶这样的物体上效果不是很好。所以，因为冬天已经烘焙了雪，就直接使用了。实时绘画现在来谈谈实时绘画。有四个质量等级：3D、2D、烘焙的图集和固定的绘画。可以看到它们有一点动画效果。对于3D绘画，简单的方法是渲染到一个渲染目标上。这样做成本很高，而且分辨率永远无法和屏幕上的匹配。所以我们选择将其展平到一个平面上，深度缓冲仍然是必需的。需要尽可能地展平，同时保留一些深度范围。这样渲染的成本相当低。这里展示的是从不同角度看它是如何被展平的图片。为了展示这一点，这张图片上四个角色都是动态的3D角色，一次性在渲染目标上渲染四个动态角色会非常昂贵。但在这个方法就没有问题。还有一个烘焙的电影图集，用于很多移动的绘画，这些都烘焙到一个图集中，以避免每帧都要渲染数十个电影。一次只激活一个这样的图集。体积云体积云，这个足以单独写一篇论文。这是内部开发的，基于Nubis的工作，这是相当常见的。它创造了这里看到的这些美丽的图片。结束语《霍格沃茨之遗》是一个非常复杂的游戏，通过多种技术管理它，无绑定资源帮助在所有平台上实现了性能目标。自动化测试是这个过程的关键组成部分。所有的视觉技术帮助在使用虚幻引擎的其他游戏中脱颖而出。为《霍格沃茨之遗》的成功感到非常自豪。感谢渲染技术团队中的每一个人，还有一些外部工程师，以及在游戏中工作的惊人艺术家，还有所有帮助过的工作室。谢谢你们。参考资料[1] https://gdcvault.com/play/1034600/Open-World-Rendering-Techniques-in
画家和程序员眼里的透视
米哈游 ZZZ 绝区零 渲染细节新发现网友发现《黑神话：悟空》误将钢筋扫描至游戏中，如何评价游戏场景实景扫描这样的做法？是怎么办到的？收藏转发，GPU、CPU、内存等150+游戏开发性能分析优化干货合集！Unity3D游戏开发中100+效果的实现和源码大全 - 收藏起来肯定用得着非广告！6年老号福利，描边、景深、泛光、投影等60+游戏后处理效果实现合集！收藏转发！原神、只狼、战神4等80+游戏渲染效果技术实现研究合集！免费！


声明：发布此文是出于传递更多知识以供交流学习之目的。若有来源标注错误或侵犯了您的合法权益，请作者持权属证明与我们联系，我们将及时更正、删除，谢谢。
鸣谢：感谢作者的授权转载，欢迎大家投稿，一起分享交流游戏开发技术。作者：zhing2006原文：https://zhuanlan.zhihu.com/p/692562877
关注【游戏开发技术教程】
游戏开发技术、技巧、教程和资源，答疑解惑，内推面试